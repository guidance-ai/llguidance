name: Rust

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      commit_id:
        description: 'Branch or Commit ID (optional)'
        required: false
        type: string
  schedule:
    # * is a special character in YAML so we quote this string
    # Run at 09:10 UTC every day
    - cron:  '10 09 * * *'

env:
  CARGO_TERM_COLOR: always

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v6
      with:
        ref: ${{ github.event_name == 'workflow_dispatch' && inputs.commit_id || github.sha }}

    - name: Check formatting
      run: cargo fmt --check

    - name: Clippy
      run: cargo clippy --workspace --all-targets --all-features -- -D warnings

    - name: Check doc links
      run: python3 scripts/checklinks.py *.md */*.md parser/src/*/*.md

    - name: Check no-default-features
      run: cargo check --no-default-features
      working-directory: parser

    - name: Check cbindgen
      run: ./scripts/cbindgen.sh --check

  rust-tests-debug:
    name: Rust Tests (debug)
    uses: ./.github/workflows/rust-tests.yml
    with:
      profile: debug
      ref: ${{ github.event_name == 'workflow_dispatch' && inputs.commit_id || github.sha }}

  rust-tests-release:
    name: Rust Tests (release)
    uses: ./.github/workflows/rust-tests.yml
    with:
      profile: release
      ref: ${{ github.event_name == 'workflow_dispatch' && inputs.commit_id || github.sha }}

  sample-parser-debug:
    name: Sample Parser (debug)
    uses: ./.github/workflows/sample-parser-tests.yml
    with:
      profile: debug
      ref: ${{ github.event_name == 'workflow_dispatch' && inputs.commit_id || github.sha }}

  sample-parser-release:
    name: Sample Parser (release)
    uses: ./.github/workflows/sample-parser-tests.yml
    with:
      profile: release
      ref: ${{ github.event_name == 'workflow_dispatch' && inputs.commit_id || github.sha }}

  c-sample:
    name: C Sample
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v6
      with:
        ref: ${{ github.event_name == 'workflow_dispatch' && inputs.commit_id || github.sha }}

    - name: Build and run C sample
      run: make
      working-directory: c_sample

  lark-tests:
    name: Lark Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v6
      with:
        ref: ${{ github.event_name == 'workflow_dispatch' && inputs.commit_id || github.sha }}

    - name: Convert GBNF to Lark
      run: ../scripts/gbnf_to_lark.py data/from-llama.cpp/*.gbnf
      working-directory: sample_parser

    - name: Build sample_parser
      run: cargo build
      working-directory: sample_parser

    - name: Run Lark tests
      run: |
        for f in data/from-llama.cpp/*.lark ; do
          ../target/debug/sample_parser "$f"
        done
      working-directory: sample_parser

  maskbench:
    name: MaskBench
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v6
      with:
        ref: ${{ github.event_name == 'workflow_dispatch' && inputs.commit_id || github.sha }}

    - name: Clone jsonschemabench
      run: git clone -b main https://github.com/guidance-ai/jsonschemabench tmp/jsonschemabench

    - name: Run MaskBench
      run: |
        mkdir -p tmp
        cargo run --release -- \
          --llg-masks \
          --expected expected_maskbench.json \
          ../tmp/jsonschemabench/maskbench/data
      working-directory: json_stats

  python-tests:
    name: Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.11", "3.14t"]

    steps:
    - name: Checkout repo
      uses: actions/checkout@v6
      with:
        ref: ${{ github.event_name == 'workflow_dispatch' && inputs.commit_id || github.sha }}

    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: ./scripts/install-deps.sh

    - name: Build and install llguidance
      run: |
        pip uninstall -y llguidance || :
        pip install -v -e .

    - name: Run mypy
      run: mypy
      working-directory: python

    - name: Detect free-threaded Python
      id: gil
      run: |
        if python -c "import sysconfig; exit(0 if sysconfig.get_config_var('Py_GIL_DISABLED') == 1 else 1)"; then
          echo "python_flags=-Xgil=0" >> "$GITHUB_OUTPUT"
        else
          echo "python_flags=" >> "$GITHUB_OUTPUT"
        fi

    - name: Run torch tests
      run: python ${{ steps.gil.outputs.python_flags }} -m pytest -v python/torch_tests/

    - name: Clone guidance
      run: git clone -b main https://github.com/guidance-ai/guidance tmp/guidance

    - name: Print guidance info
      run: echo "Branch:$(git branch --show-current) Remote:$(git remote get-url origin) HEAD:$(git rev-parse HEAD)"
      working-directory: tmp/guidance

    - name: Run guidance tests
      run: python ${{ steps.gil.outputs.python_flags }} -m pytest -v tests/unit/test_[lgmp]*.py tests/unit/library
      working-directory: tmp/guidance

    - name: Build sdist
      run: maturin build --sdist --zig

    - name: Build wheel
      run: maturin build --zig

    - name: Upload sdist and wheel artifact
      uses: actions/upload-artifact@v6
      with:
        name: wheels-${{ matrix.python-version }}
        path: target/wheels/*

  msrv:
    name: MSRV Check

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@1.87.0
      with:
        components: clippy

    - name: Build parser
      run: cargo build --verbose --locked
      working-directory: parser
